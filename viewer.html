<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>peaqer.py viewer</title>

    <style>
        body {
            font-family: sans-serif;
        }

        div#container {
            display: grid;
            grid-template-columns: auto;
        }

        div#uidiv {
            margin-top: 0em;
        }

        select#plotselect {
            font-size: large;
        }

        @media only screen and (min-width: 1200px) {
            div#container {
                grid-template-columns: auto 400px;
            }
            div#uidiv {
                margin-top: 1em;
            }
        }

    </style>

</head>
<body>
    <div id="container">
        <div id="plotdiv">
            <object type="image/svg+xml" id="plot" width="100%" height="100%"></object>
        </div>

        <div id="uidiv">
            <select id="plotselect" size="10"></select>
            <br><br>
            <div id="encoders"></div>
            <br>
            <button id="hideall">Hide All</button>
            <button id="showall">Show All</button>
        </div>
    </div>

    <script>
        window.addEventListener("DOMContentLoaded", () => {

            let all_results = null
            let checkboxes = {}
            let plot = document.querySelector("object#plot")

            function updateVisibilities() {
                function showEncoder(encoder, visible) {
                    let groups = plot.contentDocument.querySelectorAll("g#encoder_" + encoder)
                    for(let group of groups) {
                        group.setAttribute("style", visible ? "visibility:initial" : "visibility:hidden")
                    }
                }

                for(let encoder in checkboxes) {
                    showEncoder(encoder, checkboxes[encoder].checked)
                }
            }

            function hideOrShowAll(visible) {
                for(let encoder in checkboxes) {
                    checkboxes[encoder].checked = visible
                }
                updateVisibilities()
            }

            function buildEncoderSelects() {
                const encdiv = document.querySelector("div#encoders")

                let encoders = all_results.settings.encoders
                for(const key in encoders) {
                    const encoder = encoders[key]

                    let checkbox = document.createElement("input")
                    checkbox.type = "checkbox"
                    checkbox.id = key
                    checkbox.checked = true
                    checkboxes[key] = checkbox
                    checkbox.addEventListener("change", (evt) => {
                        updateVisibilities()
                    })

                    let label = document.createElement("label")
                    label.innerText = encoder.label
                    label.setAttribute("for", key)

                    encdiv.append(checkbox)
                    encdiv.append(label)
                    encdiv.append(document.createElement("br"))
                }
            }

            function loadPlot(src) {
                plot.data = src
            }


            (function init() {
                const req = new XMLHttpRequest();
                req.open("GET", "all_results.json");
                req.addEventListener("load", function() {
                    all_results = JSON.parse(req.responseText)

                    const select = document.querySelector("select#plotselect")
                    for(let file of all_results.plotfiles) {
                        const option = document.createElement("option")
                        option.text = file
                        option.value = file
                        select.append(option)
                    }
                    select.addEventListener("change", (evt) => {
                        loadPlot(evt.target.value)
                    })

                    buildEncoderSelects()

                    plot.addEventListener("load", () => {
                        updateVisibilities()
                    })

                    loadPlot(all_results.plotfiles[0])
                });
                req.send();

                document.querySelector("select#plotselect").focus()

                document.querySelector("button#hideall").addEventListener("click", () => {
                    hideOrShowAll(false)
                })

                document.querySelector("button#showall").addEventListener("click", () => {
                    hideOrShowAll(true)
                })
            })();

        })
    </script>
</body>
</html>